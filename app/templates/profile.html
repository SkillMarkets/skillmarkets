{% extends "base.html" %}
{% block content %}
<div class="card">
    <h2>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
    <p><strong>–ò–º—è:</strong> {{ user.username }}</p>
    <p><strong>Email:</strong> {{ user.email }}</p>
    <p><strong>–†–æ–ª—å:</strong> {% if user.is_tutor %}–†–µ–ø–µ—Ç–∏—Ç–æ—Ä{% else %}–°—Ç—É–¥–µ–Ω—Ç{% endif %}</p>

    <!-- –†–µ–π—Ç–∏–Ω–≥ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤) -->
    {% if user.is_tutor and user.average_rating > 0 %}
        <p><strong>–†–µ–π—Ç–∏–Ω–≥:</strong> ‚≠ê {{ user.average_rating }} ({{ user.reviews_received|length }} –æ—Ç–∑—ã–≤–æ–≤)</p>
    {% endif %}

    <!-- –£—Å–ª—É–≥–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤) -->
    {% if user.is_tutor %}
        <a href="{{ url_for('main.new_offer') }}" class="btn" style="margin:15px 0;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</a>
        {% if user.offers %}
            <h3>–í–∞—à–∏ —É—Å–ª—É–≥–∏</h3>
            {% for offer in user.offers %}
            <div style="background:#f8f9fa; padding:12px; border-radius:8px; margin:10px 0;">
                <strong>{{ offer.title }}</strong> ‚Äî ${{ offer.price_per_hour }}/—á–∞—Å<br>
                {{ offer.subject }}
            </div>
            {% endfor %}
        {% endif %}
    {% endif %}

    <!-- –û—Ç–∑—ã–≤—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä–æ–≤) -->
    {% if user.is_tutor %}
        <h3>–û—Ç–∑—ã–≤—ã –æ –≤–∞—Å</h3>
        {% if user.reviews_received %}
            {% for review in user.reviews_received %}
            <div style="background:#f8f9fa; padding:15px; border-radius:8px; margin:10px 0;">
                <strong>{{ review.reviewer.username }}:</strong> 
                ‚≠ê {{ review.rating }}/5<br>
                {{ review.comment or "–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è" }}
                <br><small>{{ review.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
            </div>
            {% endfor %}
        {% else %}
            <p>–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</p>
        {% endif %}
    {% endif %}

    <!-- –ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π -->
    <h3>–ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h3>
    {% set bookings = user.bookings_as_student if not user.is_tutor else user.bookings_as_tutor %}
    {% if bookings %}
        {% for b in bookings %}
        <div style="border-left: 4px solid var(--primary); padding-left: 15px; margin: 15px 0; background:#fafafa; border-radius:6px;">
            <!-- –ö—Ç–æ –≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ -->
            {% if user.is_tutor %}
                <p><strong>–°—Ç—É–¥–µ–Ω—Ç:</strong> {{ b.student.username }}</p>
            {% else %}
                <p><strong>–†–µ–ø–µ—Ç–∏—Ç–æ—Ä:</strong> {{ b.tutor.username }}</p>
            {% endif %}
            
            <p><strong>–£—Å–ª—É–≥–∞:</strong> {{ b.offer.title }}</p>
            <p><strong>–í—Ä–µ–º—è:</strong> {{ b.start_time.strftime('%d.%m %H:%M') }} ‚Äî {{ b.end_time.strftime('%H:%M') }}</p>
            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                {% if b.status == 'pending' %}<span style="color:#f7812e;">–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</span>
                {% elif b.status == 'confirmed' %}<span style="color:#4caf50;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>
                {% elif b.status == 'completed' %}<span style="color:green;">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                {% elif b.status == 'cancelled' %}<span style="color:#f44336;">–û—Ç–º–µ–Ω–µ–Ω–æ</span>
                {% else %}{{ b.status }}{% endif %}
            </p>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div style="margin-top:10px;">
                {% if not user.is_tutor %}
                    {% if b.status == 'pending' %}
                        <a href="{{ url_for('main.pay_booking', booking_id=b.id) }}" class="btn">üí≥ –û–ø–ª–∞—Ç–∏—Ç—å</a>
                        <a href="{{ url_for('main.chat', user_id=b.tutor.id) }}" class="btn btn-outline" style="margin-left:8px;">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</a>
                    {% elif b.status == 'completed' %}
                        {% set review_exists = False %}
                        {% for r in current_user.reviews_given %}
                            {% if r.booking_id == b.id %}
                                {% set review_exists = True %}
                            {% endif %}
                        {% endfor %}
                        {% if not review_exists %}
                            <a href="{{ url_for('main.leave_review', booking_id=b.id) }}" class="btn btn-outline">‚≠ê –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</a>
                        {% endif %}
                        <a href="{{ url_for('main.chat', user_id=b.tutor.id) }}" class="btn btn-outline" style="margin-left:8px;">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</a>
                    {% else %}
                        <a href="{{ url_for('main.chat', user_id=b.tutor.id) }}" class="btn btn-outline">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</a>
                    {% endif %}
                {% else %} <!-- user.is_tutor -->
                    {% if b.status == 'pending' %}
                        <a href="{{ url_for('main.confirm_booking', booking_id=b.id) }}" class="btn">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</a>
                        <a href="{{ url_for('main.cancel_booking', booking_id=b.id) }}" class="btn btn-outline" style="margin-left:8px;">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</a>
                        <a href="{{ url_for('main.chat', user_id=b.student.id) }}" class="btn btn-outline" style="margin-left:8px; margin-top:5px;">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</a>
                    {% elif b.status == 'confirmed' %}
                        <a href="{{ url_for('main.complete_booking', booking_id=b.id) }}" class="btn">üéâ –ó–∞–≤–µ—Ä—à–∏—Ç—å</a>
                        <a href="{{ url_for('main.chat', user_id=b.student.id) }}" class="btn btn-outline" style="margin-left:8px;">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</a>
                    {% elif b.status == 'completed' %}
                        <span style="color:green; font-weight:bold;">–ó–∞–Ω—è—Ç–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                        <a href="{{ url_for('main.chat', user_id=b.student.id) }}" class="btn btn-outline" style="margin-left:8px;">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</a>
                    {% else %}
                        <a href="{{ url_for('main.chat', user_id=b.student.id) }}" class="btn btn-outline">üí¨ –ù–∞–ø–∏—Å–∞—Ç—å</a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.</p>
    {% endif %}
</div>
{% endblock %}